% ------------------------------------------------------------------------------
#single_pair_equals
:q
[value="chommoda"]

:r
-- CTE list
WITH s1 AS
(
  -- s1: value EQ "chommoda"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  LOWER(span.value)=LOWER('chommoda')
) -- s1
-- result
, r AS
(
SELECT s1.* FROM s1
) -- r

-- merger
SELECT DISTINCT
r.id,
r.document_id,
r.p1,
r.p2,
r.type,
r.index,
r.length,
r.value,
document.author,
document.title,
document.sort_key
FROM r
INNER JOIN document ON r.document_id=document.id
ORDER BY sort_key, p1
LIMIT 20 OFFSET 0

:c
-- CTE list
WITH s1 AS
(
  -- s1: value EQ "chommoda"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  LOWER(span.value)=LOWER('chommoda')
) -- s1
-- result
, r AS
(
SELECT s1.* FROM s1
) -- r

-- merger
SELECT COUNT(*) FROM r

% ------------------------------------------------------------------------------
#single_pair_not_equals
:q
[value<>"chommoda"]

:r
-- CTE list
WITH s1 AS
(
  -- s1: value NEQ "chommoda"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  LOWER(span.value)<>LOWER('chommoda')
) -- s1
-- result
, r AS
(
SELECT s1.* FROM s1
) -- r

-- merger
SELECT DISTINCT
r.id,
r.document_id,
r.p1,
r.p2,
r.type,
r.index,
r.length,
r.value,
document.author,
document.title,
document.sort_key
FROM r
INNER JOIN document ON r.document_id=document.id
ORDER BY sort_key, p1
LIMIT 20 OFFSET 0

:c
-- CTE list
WITH s1 AS
(
  -- s1: value NEQ "chommoda"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  LOWER(span.value)<>LOWER('chommoda')
) -- s1
-- result
, r AS
(
SELECT s1.* FROM s1
) -- r

-- merger
SELECT COUNT(*) FROM r

% ------------------------------------------------------------------------------
#single_pair_non_privileged
:q
[syl_n>"4"]

:r
-- CTE list
WITH s1 AS
(
  -- s1: syl_n GT "4"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  EXISTS
  (
    SELECT * FROM span_attribute sa
    WHERE sa.span_id=span.id
    AND LOWER(sa.name)=LOWER('syl\_n')
    AND (SELECT (CASE pyt_is_numeric(value::varchar) WHEN true THEN value::double precision ELSE NULL END)) > 4
  )
) -- s1
-- result
, r AS
(
SELECT s1.* FROM s1
) -- r

-- merger
SELECT DISTINCT
r.id,
r.document_id,
r.p1,
r.p2,
r.type,
r.index,
r.length,
r.value,
document.author,
document.title,
document.sort_key
FROM r
INNER JOIN document ON r.document_id=document.id
ORDER BY sort_key, p1
LIMIT 20 OFFSET 0

:c
-- CTE list
WITH s1 AS
(
  -- s1: syl_n GT "4"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  EXISTS
  (
    SELECT * FROM span_attribute sa
    WHERE sa.span_id=span.id
    AND LOWER(sa.name)=LOWER('syl\_n')
    AND (SELECT (CASE pyt_is_numeric(value::varchar) WHEN true THEN value::double precision ELSE NULL END)) > 4
  )
) -- s1
-- result
, r AS
(
SELECT s1.* FROM s1
) -- r

-- merger
SELECT COUNT(*) FROM r

% ------------------------------------------------------------------------------
#single_pair_doc_single_pair
:q
@[author="Catullus"]; [value="chommoda"]

:r


% ------------------------------------------------------------------------------
#two_pairs_or
:q
[value="chommoda"] OR [value="commoda"]

:r
-- CTE list
WITH s1 AS
(
  -- s1: value EQ "chommoda"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  LOWER(span.value)=LOWER('chommoda')
) -- s1
, s2 AS
(
  -- s2: value EQ "commoda"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  LOWER(value)=LOWER('commoda')
) -- s2
-- result
, r AS
(
SELECT s1.* FROM s1
UNION
SELECT s2.* FROM s2
) -- r

-- merger
SELECT DISTINCT
r.id,
r.document_id,
r.p1,
r.p2,
r.type,
r.index,
r.length,
r.value,
document.author,
document.title,
document.sort_key
FROM r
INNER JOIN document ON r.document_id=document.id
ORDER BY sort_key, p1
LIMIT 20 OFFSET 0

:c
-- CTE list
WITH s1 AS
(
  -- s1: value EQ "chommoda"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  LOWER(span.value)=LOWER('chommoda')
) -- s1
, s2 AS
(
  -- s2: value EQ "commoda"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  LOWER(span.value)=LOWER('commoda')
) -- s2
-- result
, r AS
(
SELECT s1.* FROM s1
UNION
SELECT s2.* FROM s2
) -- r

-- merger
SELECT COUNT(*) FROM r

% ------------------------------------------------------------------------------
#two_pairs_and
:q
[value="chommoda"] AND [length>"5"]

:r
-- CTE list
WITH s1 AS
(
  -- s1: value EQ "chommoda"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  LOWER(span.value)=LOWER('chommoda')
) -- s1
, s2 AS
(
  -- s2: length GT "5"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  (SELECT (CASE pyt_is_numeric(length::varchar) WHEN true THEN length::double precision ELSE NULL END)) > 5
) -- s2
-- result
, r AS
(
SELECT s1.* FROM s1
INTERSECT
SELECT s2.* FROM s2
) -- r

-- merger
SELECT DISTINCT
r.id,
r.document_id,
r.p1,
r.p2,
r.type,
r.index,
r.length,
r.value,
document.author,
document.title,
document.sort_key
FROM r
INNER JOIN document ON r.document_id=document.id
ORDER BY sort_key, p1
LIMIT 20 OFFSET 0

:c
-- CTE list
WITH s1 AS
(
  -- s1: value EQ "chommoda"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  LOWER(span.value)=LOWER('chommoda')
) -- s1
, s2 AS
(
  -- s2: length GT "5"
  SELECT DISTINCT
    span.id, span.document_id, span.type,
    span.p1, span.p2, span.index, span.length,
    span.value
  FROM span
  WHERE
  span.type='tok' AND
  (SELECT (CASE pyt_is_numeric(length::varchar) WHEN true THEN length::double precision ELSE NULL END)) > 5
) -- s2
-- result
, r AS
(
SELECT s1.* FROM s1
INTERSECT
SELECT s2.* FROM s2
) -- r

-- merger
SELECT COUNT(*) FROM r
